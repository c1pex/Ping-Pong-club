<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Бронирование столов | PingPong Club</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
    }
    .booking-card {
      transition: all 0.3s ease;
    }
    .booking-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .time-slot {
      transition: all 0.2s ease;
    }
    .time-slot:hover:not(.occupied):not(.selected) {
      background-color: #dbeafe;
    }
    .time-slot.selected {
      background-color: #3b82f6;
      color: white;
    }
    .time-slot.occupied {
      background-color: #ef4444;
      color: white;
      cursor: not-allowed;
    }
    .table-available {
      border-left: 4px solid #10b981;
    }
    .table-occupied {
      border-left: 4px solid #ef4444;
    }
    .table-maintenance {
      border-left: 4px solid #f59e0b;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Навигация -->
  <header class="bg-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="index.html" class="text-2xl font-bold flex items-center space-x-2 text-pingpong-blue">
        <i class="fas fa-table-tennis-paddle-ball text-pingpong-orange"></i>
        <span>PingPong Club</span>
      </a>
      <nav class="hidden md:flex space-x-8">
        <a href="index.html" class="font-medium text-gray-600 hover:text-pingpong-blue transition">Главная</a>
        <a href="about.html" class="font-medium text-gray-600 hover:text-pingpong-blue transition">О нас</a>
        <a href="tournaments.html" class="font-medium text-gray-600 hover:text-pingpong-blue transition">Турниры</a>
        <a href="training.html" class="font-medium text-gray-600 hover:text-pingpong-blue transition">Тренировки</a>
        <a href="booking.html" class="font-medium text-pingpong-blue border-b-2 border-pingpong-blue pb-1">Бронирование</a>
        <a href="contacts.html" class="font-medium text-gray-600 hover:text-pingpong-blue transition">Контакты</a>
      </nav>
      <div class="flex items-center space-x-4">
        <a href="profile.html" class="bg-pingpong-blue text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition font-medium auth-button">
          <i class="fas fa-user mr-2"></i>Профиль
        </a>
        <button class="md:hidden text-gray-600">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Хлебные крошки -->
  <nav class="bg-gray-100 py-4">
    <div class="max-w-7xl mx-auto px-4">
      <ol class="flex items-center space-x-2 text-sm">
        <li>
          <a href="index.html" class="text-pingpong-blue hover:text-pingpong-orange transition">
            <i class="fas fa-home mr-1"></i>Главная
          </a>
        </li>
        <li class="flex items-center">
          <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </li>
        <li class="text-gray-600">
          <span>Бронирование столов</span>
        </li>
      </ol>
    </div>
  </nav>

  <!-- Основной контент -->
  <div class="max-w-7xl mx-auto px-4 py-8">
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">Бронирование столов</h1>
      <p class="text-xl text-gray-600 max-w-2xl mx-auto">Забронируйте стол для игры в удобное для вас время. Выберите дату, время и стол для бронирования.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Левая колонка - Выбор даты и времени -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h2 class="text-2xl font-bold mb-6">Выберите дату и время</h2>
          
          <!-- Календарь -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Дата бронирования</label>
            <input type="text" id="bookingDate" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="Выберите дату">
          </div>

          <!-- Выбор времени -->
          <div id="timeSelection" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-4">Доступное время</label>
            <div class="grid grid-cols-4 gap-3" id="timeSlots">
              <!-- Временные слоты будут загружены динамически -->
            </div>
          </div>
        </div>

        <!-- Выбор стола -->
        <div id="tableSelection" class="bg-white rounded-xl shadow-lg p-6 hidden">
          <h2 class="text-2xl font-bold mb-6">Выберите стол</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="tablesList">
            <!-- Столы будут загружены динамически -->
          </div>
        </div>

        <!-- Форма бронирования -->
        <div id="bookingForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
          <h2 class="text-2xl font-bold mb-6">Подтверждение бронирования</h2>
          
          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <h3 class="font-semibold mb-2">Детали бронирования:</h3>
            <p id="bookingDetails" class="text-gray-700"></p>
          </div>

          <form id="bookingFormFields">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ваше имя *</label>
                <input type="text" id="bookingName" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Телефон *</label>
                <input type="tel" id="bookingPhone" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-1">Комментарий (опционально)</label>
              <textarea id="bookingComment" rows="3" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Особые пожелания..."></textarea>
            </div>

            <div class="flex items-center justify-between">
              <div class="text-lg font-semibold">
                Стоимость: <span id="bookingPrice" class="text-green-600">300 ₽</span>
              </div>
              <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                <i class="fas fa-calendar-check mr-2"></i>Забронировать
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Правая колонка - Информация и правила -->
      <div class="space-y-6">
        <!-- Информация о бронировании -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
            Информация
          </h3>
          <ul class="space-y-3 text-gray-600">
            <li class="flex items-center">
              <i class="fas fa-clock text-green-500 mr-2"></i>
              <span>1 час = 300 ₽</span>
            </li>
            <li class="flex items-center">
              <i class="fas fa-users text-blue-500 mr-2"></i>
              <span>До 4 человек за стол</span>
            </li>
            <li class="flex items-center">
              <i class="fas fa-calendar-times text-orange-500 mr-2"></i>
              <span>Отмена за 2 часа бесплатно</span>
            </li>
            <li class="flex items-center">
              <i class="fas fa-utensils text-purple-500 mr-2"></i>
              <span>Бар и кафе на месте</span>
            </li>
          </ul>
        </div>

        <!-- Правила бронирования -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>
            Правила
          </h3>
          <ul class="space-y-2 text-sm text-gray-600">
            <li>• Бронирование подтверждается после оплаты</li>
            <li>• Оплата на месте или онлайн</li>
            <li>• Опоздание более 15 мин = отмена брони</li>
            <li>• Повреждение инвентаря = компенсация</li>
            <li>• Соблюдайте правила клуба</li>
          </ul>
        </div>

        <!-- Мои бронирования -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-history text-purple-500 mr-2"></i>
            Мои бронирования
          </h3>
          <div id="myBookings">
            <!-- Бронирования будут загружены -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Подвал -->
  <footer class="bg-gray-900 text-white py-12 mt-12">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-table-tennis-paddle-ball text-pingpong-orange mr-2"></i>
            PingPong Club
          </h3>
          <p class="text-gray-400">Лучший клуб настольного тенниса в вашем городе.</p>
        </div>
        <div>
          <h4 class="font-bold mb-4">Навигация</h4>
          <ul class="space-y-2">
            <li><a href="index.html" class="text-gray-400 hover:text-white transition">Главная</a></li>
            <li><a href="about.html" class="text-gray-400 hover:text-white transition">О нас</a></li>
            <li><a href="tournaments.html" class="text-gray-400 hover:text-white transition">Турниры</a></li>
            <li><a href="training.html" class="text-gray-400 hover:text-white transition">Тренировки</a></li>
            <li><a href="booking.html" class="text-gray-400 hover:text-white transition">Бронирование</a></li>
            <li><a href="contacts.html" class="text-gray-400 hover:text-white transition">Контакты</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-bold mb-4">Контакты</h4>
          <ul class="space-y-2 text-gray-400">
            <li class="flex items-center"><i class="fas fa-map-marker-alt mr-2"></i> г. Москва, ул. Спортивная, 15</li>
            <li class="flex items-center"><i class="fas fa-phone mr-2"></i> +7 (999) 123-45-67</li>
            <li class="flex items-center"><i class="fas fa-envelope mr-2"></i> info@pingpongclub.ru</li>
          </ul>
        </div>
        <div>
          <h4 class="font-bold mb-4">Мы в соцсетях</h4>
          <div class="flex space-x-4">
            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-vk text-xl"></i></a>
            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-telegram text-xl"></i></a>
            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-instagram text-xl"></i></a>
            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-youtube text-xl"></i></a>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
        <p>&copy; 2025 PingPong Club. Все права защищены.</p>
      </div>
    </div>
  </footer>

  <!-- Подключаем Flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

  <!-- Основной скрипт бронирования -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCIfPeJSURQW_TNBYvaKcsX6bDtMLwr-ZE",
      authDomain: "tennizov.firebaseapp.com",
      databaseURL: "https://tennizov-default-rtdb.firebaseio.com",
      projectId: "tennizov",
      storageBucket: "tennizov.appspot.com",
      messagingSenderId: "194989527761",
      appId: "1:194989527761:web:c0a4ba1fcf9484709fabf0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Текущее состояние бронирования
    let bookingState = {
      selectedDate: null,
      selectedTime: null,
      selectedTable: null,
      selectedDuration: 60 // 60 минут по умолчанию
    };

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', function() {
      initBookingSystem();
      loadMyBookings();
    });

    function initBookingSystem() {
      initDatePicker();
      initEventListeners();
    }

    function initDatePicker() {
      flatpickr("#bookingDate", {
        locale: "ru",
        minDate: "today",
        dateFormat: "d.m.Y",
        disable: [
          function(date) {
            // Отключаем понедельник (день технического обслуживания)
            return date.getDay() === 1;
          }
        ],
        onChange: function(selectedDates, dateStr, instance) {
          bookingState.selectedDate = dateStr;
          loadAvailableTimeSlots(dateStr);
        }
      });
    }

    function initEventListeners() {
      // Форма бронирования
      document.getElementById('bookingFormFields').addEventListener('submit', handleBookingSubmit);
    }

    // Загрузка доступных временных слотов
    async function loadAvailableTimeSlots(date) {
      const timeSlotsContainer = document.getElementById('timeSlots');
      timeSlotsContainer.innerHTML = '<div class="col-span-4 text-center py-4 text-gray-500">Загрузка...</div>';

      // Показываем выбор времени
      document.getElementById('timeSelection').classList.remove('hidden');
      document.getElementById('tableSelection').classList.add('hidden');
      document.getElementById('bookingForm').classList.add('hidden');

      // Генерируем временные слоты (9:00 - 22:00)
      const timeSlots = generateTimeSlots();
      
      // Проверяем занятые слоты в базе данных
      const occupiedSlots = await getOccupiedTimeSlots(date);

      timeSlotsContainer.innerHTML = '';
      
      timeSlots.forEach(slot => {
        const isOccupied = occupiedSlots.some(occupied => 
          occupied.time === slot.time && occupied.duration === slot.duration
        );

        const slotElement = document.createElement('button');
        slotElement.type = 'button';
        slotElement.className = `time-slot py-3 px-4 rounded-lg border text-sm font-medium ${
          isOccupied ? 'occupied' : 'bg-white border-gray-300 hover:border-blue-500'
        }`;
        slotElement.textContent = slot.time;
        slotElement.disabled = isOccupied;

        if (!isOccupied) {
          slotElement.addEventListener('click', () => selectTimeSlot(slot));
        }

        timeSlotsContainer.appendChild(slotElement);
      });
    }

    function generateTimeSlots() {
      const slots = [];
      const startHour = 9; // 9:00
      const endHour = 22; // 22:00
        
      for (let hour = startHour; hour < endHour; hour++) {
        slots.push({
          time: `${hour.toString().padStart(2, '0')}:00`,
          duration: 60
        });
      }
      
      return slots;
    }

    async function getOccupiedTimeSlots(date) {
      try {
        const bookingsRef = ref(db, 'Bookings');
        const dateQuery = query(bookingsRef, orderByChild('date'), equalTo(date));
        const snapshot = await get(dateQuery);
        
        if (snapshot.exists()) {
          return Object.values(snapshot.val()).map(booking => ({
            time: booking.time,
            duration: booking.duration
          }));
        }
        return [];
      } catch (error) {
        console.error('Ошибка загрузки занятых слотов:', error);
        return [];
      }
    }

    function selectTimeSlot(slot) {
      bookingState.selectedTime = slot.time;
      bookingState.selectedDuration = slot.duration;
      
      // Убираем выделение у всех слотов
      document.querySelectorAll('.time-slot').forEach(s => {
        s.classList.remove('selected', 'bg-blue-500', 'text-white');
      });
      
      // Выделяем выбранный слот
      event.target.classList.add('selected', 'bg-blue-500', 'text-white');
      
      // Показываем выбор столов
      loadAvailableTables();
    }

    async function loadAvailableTables() {
      document.getElementById('tableSelection').classList.remove('hidden');
      
      const tablesList = document.getElementById('tablesList');
      tablesList.innerHTML = '<div class="col-span-2 text-center py-4 text-gray-500">Загрузка столов...</div>';

      // Получаем занятые столы на выбранное время
      const occupiedTables = await getOccupiedTables(bookingState.selectedDate, bookingState.selectedTime);

      // Список всех столов в клубе
      const allTables = [
        { id: 'table1', name: 'Стол 1', type: 'professional', price: 400 },
        { id: 'table2', name: 'Стол 2', type: 'standard', price: 300 },
        { id: 'table3', name: 'Стол 3', type: 'standard', price: 300 },
        { id: 'table4', name: 'Стол 4', type: 'training', price: 250 },
        { id: 'table5', name: 'Стол 5', type: 'training', price: 250 },
        { id: 'table6', name: 'Стол 6', type: 'standard', price: 300 }
      ];

      tablesList.innerHTML = '';

      allTables.forEach(table => {
        const isOccupied = occupiedTables.includes(table.id);
        const isMaintenance = table.id === 'table1' && new Date().getDay() === 1; // Пример: стол 1 на обслуживании по понедельникам

        const tableCard = document.createElement('div');
        tableCard.className = `booking-card p-4 rounded-lg border-2 ${
          isOccupied ? 'table-occupied bg-red-50 border-red-200' :
          isMaintenance ? 'table-maintenance bg-yellow-50 border-yellow-200' :
          'table-available bg-green-50 border-green-200'
        } cursor-pointer transition-all`;
        
        tableCard.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold text-lg">${table.name}</h3>
            <span class="text-sm font-medium ${isOccupied ? 'text-red-600' : 'text-green-600'}">
              ${isOccupied ? 'Занят' : isMaintenance ? 'Обслуживание' : 'Свободен'}
            </span>
          </div>
          <p class="text-sm text-gray-600 mb-2">${getTableTypeText(table.type)}</p>
          <p class="text-lg font-bold text-blue-600">${table.price} ₽/час</p>
          ${!isOccupied && !isMaintenance ? 
            `<button class="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition select-table-btn" data-table='${JSON.stringify(table)}'>
               Выбрать
             </button>` : 
            `<button class="w-full mt-3 bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed" disabled>
               Недоступен
             </button>`
          }
        `;

        if (!isOccupied && !isMaintenance) {
          tableCard.querySelector('.select-table-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            selectTable(table);
          });
        }

        tablesList.appendChild(tableCard);
      });
    }

    function getTableTypeText(type) {
      const types = {
        'professional': 'Профессиональный',
        'standard': 'Стандартный', 
        'training': 'Тренировочный'
      };
      return types[type] || type;
    }

    async function getOccupiedTables(date, time) {
      try {
        const bookingsRef = ref(db, 'Bookings');
        const dateQuery = query(bookingsRef, orderByChild('date'), equalTo(date));
        const snapshot = await get(dateQuery);
        
        if (snapshot.exists()) {
          const bookings = Object.values(snapshot.val());
          return bookings
            .filter(booking => booking.time === time)
            .map(booking => booking.tableId);
        }
        return [];
      } catch (error) {
        console.error('Ошибка загрузки занятых столов:', error);
        return [];
      }
    }

    function selectTable(table) {
      bookingState.selectedTable = table;
      
      // Показываем форму бронирования
      showBookingForm();
    }

    function showBookingForm() {
      document.getElementById('bookingForm').classList.remove('hidden');
      
      // Обновляем детали бронирования
      const details = `
        Дата: ${bookingState.selectedDate}<br>
        Время: ${bookingState.selectedTime}<br>
        Длительность: ${bookingState.selectedDuration} мин<br>
        Стол: ${bookingState.selectedTable.name}<br>
        Тип: ${getTableTypeText(bookingState.selectedTable.type)}
      `;
      
      document.getElementById('bookingDetails').innerHTML = details;
      document.getElementById('bookingPrice').textContent = `${bookingState.selectedTable.price} ₽`;
      
      // Если пользователь авторизован, подставляем его данные
      const user = auth.currentUser;
      if (user) {
        loadUserProfileData();
      }
    }

    async function loadUserProfileData() {
      try {
        const user = auth.currentUser;
        if (!user) return;

        const userRef = ref(db, `Users/${user.uid}/profile`);
        const snapshot = await get(userRef);
        
        if (snapshot.exists()) {
          const profile = snapshot.val();
          document.getElementById('bookingName').value = profile.name || '';
          document.getElementById('bookingPhone').value = profile.phone || '';
        }
      } catch (error) {
        console.error('Ошибка загрузки профиля:', error);
      }
    }

    async function handleBookingSubmit(e) {
      e.preventDefault();
      
      const bookingData = {
        date: bookingState.selectedDate,
        time: bookingState.selectedTime,
        duration: bookingState.selectedDuration,
        tableId: bookingState.selectedTable.id,
        tableName: bookingState.selectedTable.name,
        tableType: bookingState.selectedTable.type,
        price: bookingState.selectedTable.price,
        customerName: document.getElementById('bookingName').value,
        customerPhone: document.getElementById('bookingPhone').value,
        comment: document.getElementById('bookingComment').value,
        status: 'confirmed',
        createdAt: new Date().toISOString(),
        userId: auth.currentUser ? auth.currentUser.uid : null
      };

      try {
        // Сохраняем бронирование в базе данных
        await push(ref(db, 'Bookings'), bookingData);
        
        // Показываем уведомление об успехе
        showBookingSuccess(bookingData);
        
        // Сбрасываем форму
        resetBookingForm();
        
        // Обновляем список бронирований
        loadMyBookings();
        
      } catch (error) {
        console.error('Ошибка бронирования:', error);
        alert('Произошла ошибка при бронировании. Пожалуйста, попробуйте еще раз.');
      }
    }

    function showBookingSuccess(bookingData) {
      const successMessage = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-xl p-6 max-w-md mx-4 text-center">
            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
            <h3 class="text-2xl font-bold mb-2">Бронирование подтверждено!</h3>
            <p class="text-gray-600 mb-4">
              Стол "${bookingData.tableName}" забронирован на<br>
              <strong>${bookingData.date} в ${bookingData.time}</strong>
            </p>
            <p class="text-sm text-gray-500 mb-4">
              Стоимость: ${bookingData.price} ₽<br>
              Оплата на месте
            </p>
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
              Понятно
            </button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', successMessage);
    }

    function resetBookingForm() {
      bookingState = {
        selectedDate: null,
        selectedTime: null, 
        selectedTable: null,
        selectedDuration: 60
      };
      
      document.getElementById('bookingDate').value = '';
      document.getElementById('timeSelection').classList.add('hidden');
      document.getElementById('tableSelection').classList.add('hidden');
      document.getElementById('bookingForm').classList.add('hidden');
      document.getElementById('bookingFormFields').reset();
    }

    // Загрузка моих бронирований
    async function loadMyBookings() {
      const myBookingsContainer = document.getElementById('myBookings');
      
      if (!auth.currentUser) {
        myBookingsContainer.innerHTML = `
          <p class="text-gray-500 text-center py-4">
            <a href="authorization.html" class="text-blue-600 hover:underline">Войдите</a>, чтобы видеть свои бронирования
          </p>
        `;
        return;
      }

      try {
        const bookingsRef = ref(db, 'Bookings');
        const userQuery = query(bookingsRef, orderByChild('userId'), equalTo(auth.currentUser.uid));
        const snapshot = await get(userQuery);
        
        if (!snapshot.exists()) {
          myBookingsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">У вас пока нет бронирований</p>';
          return;
        }

        const bookings = Object.entries(snapshot.val())
          .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
          .slice(0, 3); // Показываем последние 3 бронирования

        myBookingsContainer.innerHTML = '';
        
        bookings.forEach(([id, booking]) => {
          const bookingElement = document.createElement('div');
          bookingElement.className = 'bg-gray-50 rounded-lg p-3 mb-2';
          bookingElement.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <p class="font-semibold">${booking.tableName}</p>
                <p class="text-sm text-gray-600">${booking.date} в ${booking.time}</p>
              </div>
              <span class="px-2 py-1 text-xs rounded-full ${
                booking.status === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
              }">
                ${booking.status === 'confirmed' ? 'Подтверждено' : 'Ожидание'}
              </span>
            </div>
          `;
          myBookingsContainer.appendChild(bookingElement);
        });

        if (bookings.length === 0) {
          myBookingsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">У вас пока нет бронирований</p>';
        }

      } catch (error) {
        console.error('Ошибка загрузки бронирований:', error);
        myBookingsContainer.innerHTML = '<p class="text-red-500 text-center py-4">Ошибка загрузки</p>';
      }
    }

    // Слушатель изменения состояния авторизации
    onAuthStateChanged(auth, (user) => {
      const authButton = document.querySelector('.auth-button');
      
      if (user) {
        authButton.innerHTML = `<i class="fas fa-user mr-2"></i>${user.displayName || user.email}`;
        authButton.href = "profile.html";
        loadMyBookings();
      } else {
        authButton.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Вход';
        authButton.href = "authorization.html";
      }
    });

    // Обработчик клика по кнопке профиля
    document.querySelector('.auth-button').addEventListener('click', function(e) {
      const user = auth.currentUser;
      if (!user) {
        e.preventDefault();
        window.location.href = 'authorization.html';
      }
    });
  </script>
</body>
</html>